#!/usr/bin/env bash

##
# Detect the ownership of the webroot
# and run php as that user.
#
main() {
    local owner group owner_id group_id tmp
    read owner group owner_id group_id < <(stat -c '%U %G %u %g' .)

    if [[ ${owner} = UNKNOWN ]]; then
        owner=$(getname)
        if [[ ${group} = UNKNOWN ]]; then
            group=${owner}
            addgroup -S -g "$group_id" "$group"
        fi
        adduser -S -u ${owner_id} -G "$owner" "$owner"
    fi
    prepare ${owner} ${group}

}

getname() {
    echo "backend"
}

prepare() {
    if [[ -f /usr/local/etc/php-fpm.d/www.conf ]];then
        sed -i "s/user = .*/user = ${1}/" /usr/local/etc/php-fpm.d/www.conf && \
        sed -i "s/group = .*/group = ${2}/" /usr/local/etc/php-fpm.d/www.conf
    fi
    # Not volumes, so need to be chowned
    chown -R "$owner:$group" /app/var/
}

runAsUser()
{
	DEFAULT_USER=$(getname)
	USER=${2:-${DEFAULT_USER}}
	sudo -u ${USER} bash -c "${1}"
}